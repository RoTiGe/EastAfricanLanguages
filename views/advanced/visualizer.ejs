<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #network-graph {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .node {
            cursor: pointer;
        }
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
        }
        .node text {
            font-size: 12px;
            pointer-events: none;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <header class="text-white py-4 position-relative">
            <div class="container">
                <a href="/" class="btn btn-light position-absolute top-0 start-0 m-3">
                    <i class="bi bi-arrow-left me-2"></i>Back to Home
                </a>
                <h1 class="text-center display-5 fw-bold"><%= title %></h1>
            </div>
        </header>

        <main class="container my-4">
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                Interactive network visualization of category relationships and priorities. Drag nodes to explore connections.
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="h5 mb-3">Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #e74c3c;"></span>
                            <span>Priority 1-3 (Critical)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #f39c12;"></span>
                            <span>Priority 4-6 (Important)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #3498db;"></span>
                            <span>Priority 7-9 (Standard)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #95a5a6;"></span>
                            <span>Priority 10+ (Optional)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <div id="network-graph"></div>
                </div>
            </div>

            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h3 class="h5 mb-3">Category Details</h3>
                    <div id="category-info" class="text-muted">
                        Click on a node to see details
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-dark text-white text-center py-4 mt-5">
            <div class="container">
                <p class="mb-0">Network Visualizer - Advanced Mode</p>
            </div>
        </footer>
    </div>

    <script>
        const categoriesData = <%- categoriesJson %>;
        
        // Create network graph
        function createNetworkGraph() {
            const width = document.getElementById('network-graph').offsetWidth;
            const height = 600;

            // Clear existing SVG
            d3.select('#network-graph').html('');

            const svg = d3.select('#network-graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create nodes from categories
            const nodes = categoriesData.categories.map(cat => ({
                id: cat.id,
                name: cat.name,
                priority: cat.priority,
                description: cat.description,
                personas: cat.personas,
                subcategories: cat.subcategories
            }));

            // Create links based on priority proximity and shared personas
            const links = [];
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const sharedPersonas = nodes[i].personas.filter(p => 
                        nodes[j].personas.includes(p)
                    );
                    
                    if (sharedPersonas.length > 0 || 
                        Math.abs(nodes[i].priority - nodes[j].priority) <= 2) {
                        links.push({
                            source: nodes[i].id,
                            target: nodes[j].id,
                            strength: sharedPersonas.length
                        });
                    }
                }
            }

            // Color scale based on priority
            const colorScale = (priority) => {
                if (priority <= 3) return '#e74c3c';
                if (priority <= 6) return '#f39c12';
                if (priority <= 9) return '#3498db';
                return '#95a5a6';
            };

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(50));

            // Draw links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.max(1, d.strength));

            // Draw nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', d => 10 + (10 - d.priority) * 2)
                .attr('fill', d => colorScale(d.priority))
                .on('click', showCategoryInfo);

            node.append('text')
                .attr('dx', 15)
                .attr('dy', 4)
                .text(d => d.name);

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            // Show category info
            function showCategoryInfo(event, d) {
                const infoDiv = document.getElementById('category-info');
                infoDiv.innerHTML = `
                    <h4 class="h6 mb-3">${d.name} <span class="badge bg-primary">Priority ${d.priority}</span></h4>
                    <p><strong>Description:</strong> ${d.description}</p>
                    <p><strong>Subcategories:</strong> ${d.subcategories.join(', ')}</p>
                    <p><strong>Personas:</strong> ${d.personas.join(', ')}</p>
                `;
            }
        }

        // Initialize on load
        window.addEventListener('load', createNetworkGraph);
        window.addEventListener('resize', createNetworkGraph);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
